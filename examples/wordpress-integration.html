<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WordPress ChatKit Integration Example</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      line-height: 1.6;
    }
    .code-block {
      background: #2d2d2d;
      color: #f8f8f2;
      padding: 20px;
      border-radius: 5px;
      overflow-x: auto;
      margin: 20px 0;
    }
    .code-block code {
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.6;
    }
    h1, h2, h3 {
      color: #333;
    }
    .note {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 15px;
      margin: 20px 0;
    }
    .success {
      background: #d4edda;
      border-left: 4px solid #28a745;
      padding: 15px;
      margin: 20px 0;
    }
  </style>
</head>
<body>
  <h1>WordPress ChatKit Integration Guide</h1>
  
  <div class="note">
    <strong>Note:</strong> This example shows how to integrate the ChatKit widget into your WordPress site using the token service you've deployed.
  </div>

  <h2>Step 1: Add JavaScript to WordPress Theme</h2>
  
  <p>Add this code to your theme's <code>footer.php</code> or use the <code>wp_footer</code> action hook:</p>

  <div class="code-block">
    <code>&lt;!-- ChatKit Integration --&gt;
&lt;script type="module"&gt;
  // Configuration - Update with your deployed Worker URL
  const CHATKIT_WORKER_URL = 'https://chatkit.beepi.no';
  
  // Session management
  let currentSession = null;
  
  /**
   * Get or refresh ChatKit client secret
   * This function is called by ChatKit when it needs authentication
   */
  async function getClientSecret() {
    const now = Math.floor(Date.now() / 1000);
    
    // Return cached token if still valid (with 60s buffer)
    if (currentSession && currentSession.expires_at > now + 60) {
      console.log('ChatKit: Using cached token');
      return currentSession.client_secret;
    }
    
    try {
      // Determine endpoint (refresh vs. start)
      const endpoint = currentSession 
        ? '/api/chatkit/refresh' 
        : '/api/chatkit/start';
        
      const body = currentSession 
        ? JSON.stringify({ currentClientSecret: currentSession.client_secret })
        : '{}';
      
      console.log('ChatKit: Requesting token from', endpoint);
      
      // Request token from Worker
      const response = await fetch(CHATKIT_WORKER_URL + endpoint, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: body,
      });
      
      if (!response.ok) {
        const error = await response.json();
        console.error('ChatKit: Token error', error);
        throw new Error(error.message || 'Failed to get token');
      }
      
      currentSession = await response.json();
      console.log('ChatKit: Token received, expires at', new Date(currentSession.expires_at * 1000));
      
      return currentSession.client_secret;
    } catch (error) {
      console.error('ChatKit: Error getting token', error);
      throw error;
    }
  }
  
  /**
   * Initialize ChatKit widget
   */
  async function initializeChatKit() {
    try {
      // Import ChatKit from CDN
      const { renderChatkit } = await import('https://cdn.jsdelivr.net/npm/@openai/chatkit@latest/dist/index.js');
      
      console.log('ChatKit: Initializing widget');
      
      // Render ChatKit with authentication
      renderChatkit({
        getClientSecret: getClientSecret,
        
        // Optional: Customize ChatKit appearance
        // theme: 'light',
        // position: 'bottom-right',
        
        // Optional: Custom container
        // container: document.getElementById('chatkit-container'),
        
        // Optional: Event handlers
        onOpen: () => {
          console.log('ChatKit: Widget opened');
        },
        onClose: () => {
          console.log('ChatKit: Widget closed');
        },
        onError: (error) => {
          console.error('ChatKit: Error', error);
        },
      });
      
      console.log('ChatKit: Widget initialized successfully');
    } catch (error) {
      console.error('ChatKit: Initialization error', error);
    }
  }
  
  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeChatKit);
  } else {
    initializeChatKit();
  }
&lt;/script&gt;</code>
  </div>

  <h2>Step 2: Add via WordPress Plugin (Alternative)</h2>
  
  <p>Create a custom plugin with this code:</p>

  <div class="code-block">
    <code>&lt;?php
/**
 * Plugin Name: ChatKit Integration
 * Description: Integrates OpenAI ChatKit with token service
 * Version: 1.0.0
 */

// Prevent direct access
if (!defined('ABSPATH')) {
    exit;
}

/**
 * Add ChatKit script to footer
 */
function chatkit_add_scripts() {
    // Only load on frontend
    if (is_admin()) {
        return;
    }
    
    // Get Worker URL from WordPress options or define it here
    $worker_url = get_option('chatkit_worker_url', 'https://chatkit.beepi.no');
    
    ?&gt;
    &lt;script type="module"&gt;
      const CHATKIT_WORKER_URL = '&lt;?php echo esc_js($worker_url); ?&gt;';
      let currentSession = null;
      
      async function getClientSecret() {
        const now = Math.floor(Date.now() / 1000);
        if (currentSession && currentSession.expires_at > now + 60) {
          return currentSession.client_secret;
        }
        
        const endpoint = currentSession ? '/api/chatkit/refresh' : '/api/chatkit/start';
        const body = currentSession 
          ? JSON.stringify({ currentClientSecret: currentSession.client_secret })
          : '{}';
        
        const response = await fetch(CHATKIT_WORKER_URL + endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: body,
        });
        
        if (!response.ok) throw new Error('Failed to get token');
        currentSession = await response.json();
        return currentSession.client_secret;
      }
      
      async function init() {
        const { renderChatkit } = await import('https://cdn.jsdelivr.net/npm/@openai/chatkit@latest/dist/index.js');
        renderChatkit({ getClientSecret });
      }
      
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    &lt;/script&gt;
    &lt;?php
}
add_action('wp_footer', 'chatkit_add_scripts');

/**
 * Add settings page (optional)
 */
function chatkit_add_settings_page() {
    add_options_page(
        'ChatKit Settings',
        'ChatKit',
        'manage_options',
        'chatkit-settings',
        'chatkit_settings_page'
    );
}
add_action('admin_menu', 'chatkit_add_settings_page');

function chatkit_settings_page() {
    if (isset($_POST['chatkit_worker_url'])) {
        check_admin_referer('chatkit_settings');
        update_option('chatkit_worker_url', sanitize_text_field($_POST['chatkit_worker_url']));
        echo '&lt;div class="notice notice-success"&gt;&lt;p&gt;Settings saved!&lt;/p&gt;&lt;/div&gt;';
    }
    
    $worker_url = get_option('chatkit_worker_url', '');
    ?&gt;
    &lt;div class="wrap"&gt;
        &lt;h1&gt;ChatKit Settings&lt;/h1&gt;
        &lt;form method="post"&gt;
            &lt;?php wp_nonce_field('chatkit_settings'); ?&gt;
            &lt;table class="form-table"&gt;
                &lt;tr&gt;
                    &lt;th&gt;&lt;label for="chatkit_worker_url"&gt;Worker URL&lt;/label&gt;&lt;/th&gt;
                    &lt;td&gt;
                        &lt;input type="url" 
                               id="chatkit_worker_url" 
                               name="chatkit_worker_url" 
                               value="&lt;?php echo esc_attr($worker_url); ?&gt;" 
                               class="regular-text" 
                               placeholder="https://chatkit.beepi.no"&gt;
                        &lt;p class="description"&gt;Your Cloudflare Worker URL for ChatKit token service&lt;/p&gt;
                    &lt;/td&gt;
                &lt;/tr&gt;
            &lt;/table&gt;
            &lt;?php submit_button(); ?&gt;
        &lt;/form&gt;
    &lt;/div&gt;
    &lt;?php
}
</code>
  </div>

  <h2>Step 3: Configure CORS</h2>
  
  <div class="note">
    <strong>Important:</strong> Configure your WordPress domain in <code>ALLOWED_ORIGINS</code> in your Cloudflare Worker's <code>wrangler.toml</code> file.
  </div>

  <div class="code-block">
    <code># Edit wrangler.toml and add your allowed origins under [vars]:
[vars]
ALLOWED_ORIGINS = "https://yourwordpresssite.com,https://www.yourwordpresssite.com"

# Then redeploy:
npm run deploy</code>
  </div>

  <h2>Step 4: Test Integration</h2>
  
  <ol>
    <li>Load your WordPress site in a browser</li>
    <li>Open the browser's Developer Console (F12)</li>
    <li>Look for ChatKit initialization logs</li>
    <li>The ChatKit widget should appear on your page</li>
    <li>Test chatting to verify tokens are working</li>
  </ol>

  <div class="success">
    <strong>Success!</strong> Your WordPress site now has ChatKit integrated with secure token management through your Cloudflare Worker.
  </div>

  <h2>Troubleshooting</h2>
  
  <h3>ChatKit doesn't appear</h3>
  <ul>
    <li>Check browser console for errors</li>
    <li>Verify Worker URL is correct</li>
    <li>Ensure ChatKit CDN is accessible</li>
    <li>Check for JavaScript conflicts with other plugins</li>
  </ul>

  <h3>CORS errors</h3>
  <ul>
    <li>Verify <code>ALLOWED_ORIGINS</code> in <code>wrangler.toml</code> under <code>[vars]</code> includes your domain</li>
    <li>Check that domain matches exactly (https vs http, www vs non-www)</li>
    <li>Test CORS with: <code>curl -X OPTIONS https://chatkit.beepi.no/api/chatkit/start -H "Origin: https://yoursite.com" -v</code></li>
  </ul>

  <h3>"Failed to get token" errors</h3>
  <ul>
    <li>Verify Worker secrets are set correctly</li>
    <li>Check OpenAI API key is valid</li>
    <li>View Worker logs: <code>wrangler tail</code></li>
    <li>Ensure you have Realtime API access</li>
  </ul>

</body>
</html>
